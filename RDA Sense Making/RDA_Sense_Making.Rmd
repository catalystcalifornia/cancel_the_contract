---
title: "Cancel the Contract Preliminary Research Findings"
subtitle: "RDA Data Sense Making Session [INTERNAL USE ONLY]"
author: "By Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    toc: yes
    toc_depth: 3
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)


#### Load libraries ####
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
library(flextable)
library(htmlwidgets)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(scales)
library(dplyr)
library(ggplot2)
library(tidytext)


#add function that better fits the tables to the page    
FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

#### Add database connection ####

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("eci_fresno_ripa")

#### Read in tables you need from postgres ####

# You can use the RDA Data Dictionary to look up column meta data for any of these tables. The dictionary is structured the same as pgadmin: https://www.healthycity.org/rda-dev/pgdatadictionary/ 

stops<-dbGetQuery(con, "SELECT * FROM rel_stops")
results<-dbGetQuery(con, "SELECT * FROM rel_stops_result")
person<-dbGetQuery(con, "SELECT * FROM rel_persons")
person_reason<-dbGetQuery(con, "SELECT * FROM rel_persons_reason")
age<-dbGetQuery(con, "SELECT * FROM rel_age")
race<-dbGetQuery(con, "SELECT * FROM rel_races_recode") 
person_result<-dbGetQuery(con, "SELECT * FROM rel_persons_result")
actions<-dbGetQuery(con, "SELECT * FROM rel_stops_actions")
reason<-dbGetQuery(con, "SELECT * FROM rel_stops_reason")
person_action<-dbGetQuery(con, "SELECT * FROM rel_persons_actions")
search<-dbGetQuery(con, "SELECT * FROM rel_stops_searches")

# read in offense codes
offense_codes<-dbGetQuery(con, "SELECT * FROM cadoj_ripa_offense_codes_2023")

pop<-dbGetQuery(con, "SELECT * from population_race_fresno_city")

```

