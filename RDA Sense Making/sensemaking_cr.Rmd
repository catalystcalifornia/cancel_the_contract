---
title: ""
output:
  html_document:
    includes:
      in_header: "../header.html"
    mathjax: null
---

```{r, include=FALSE}
# Check if document is being run as a child, if yes don't apply styling again
is_child <- !is.null(knitr::opts_knit$get("parent.frame"))
if (is_child) {
  knitr::opts_chunk$set(include = FALSE)
}
```

```{r, include=FALSE}

# Set up (add any additional libraries you may need)-----------------------------

library(RPostgres)
library(devtools)
library(stringr)
library(dplyr)
library(tidyr)
library(flextable)
library(ggplot2)

#connect to postgres-----------------

source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("cancel_the_contract")
con_shared <- connect_to_db("rda_shared_data")

# Visualization tools (optional!)-------------------------

#add function that better fits the tables to the page

FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

# See "W:\Project\RJS\CTC\Github\JZ\cancel_the_contract\RDA Sense Making\sensemaking_jz.Rmd" for one ggplot and one flextable example
# if you want to visualize tables quickly


# Guiding questions-------------------------

#1) What findings are you seeing that are interesting or surprising to you?
#2) What findings are you seeing that supplement OR contradict our narrative? 
#3) What additional questions do you have?
#4) What visualization ideas (chart types, figures to highlight, etc.) do you have? 

```

## CR General notes

* Law enforcement stopped students in 904 stops between 2018 and 2023 (right?).
* Law enforcement responded to a call for service in 317 of the 904 stops, or 35% of stops.
* In other words, law enforcement chose to stop students in 65% of stops (587 of 904).
* Nearly half of stops were for school fights and smoking marijuana, neither of which should require law enforcement.
* Whether in response to a call or by officer choice, law enforcement said there was a reasonable suspicion that the person was engaged in criminal activity in roughly 90% of stops of students. The other 10% of stops were because of a consensual encounter and search, to determine if a student violated a school policy, to determine whether a student in truant, an outstanding arrest warrant, a possible Ed Code violation, or traffic violation.
* Whether a student violated a school policy or Ed Code should be investigated by school staff NOT law enforcement. That was 4.2% of stops.
* 15% of stops where the officer had a reasonable suspicion that the person was engaged in criminal activity were due to the student matching the a description. Stops where someone matches a description are fraught with error.
* Law enforcement stopped students for a number unnecessary reasons including disrupting classwork, disruption of school activities, willfully disturbing a school zone, loud noise, litter, jaywalking, bothering other children, possessing unlawful paraphernalia.
* Very different not school with traffic violation being number one.

```{r}

stops_reason_avuhsd<-dbGetQuery(con, "SELECT * FROM analysis_stops_reason_avuhsd")

# Supplemental reason analysis using word count / narrative column method. But I think for more precision we should primarily rely on the tables above for the stop reason analysis.

stops_reason_reason_narrative_avuhsd<-dbGetQuery(con, "SELECT * FROM analysis_stops_reason_and_narrative_avuhsd")
stops_reason_narrative_avuhsd<-dbGetQuery(con, "SELECT * FROM analysis_stops_narrative_avuhsd")

```


```{r}
stops_reason_rs_avuhsd<-dbGetQuery(con, "SELECT * FROM analysis_stops_reason_rs_avuhsd")
stops_reason_rs_codes_avuhsd<-dbGetQuery(con, "SELECT * FROM analysis_stops_reason_rs_codes_avuhsd")

```


```{r}

stops_stops_reason_age<-dbGetQuery(con, "SELECT * FROM analysis_stops_reason_age")
stops_stops_reason_age_race<-dbGetQuery(con, "SELECT * FROM analysis_stops_reason_age_race")

```


