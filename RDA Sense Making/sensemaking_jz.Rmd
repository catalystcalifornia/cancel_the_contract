---
title: ""
output:
  html_document:
    includes:
      in_header: "../header.html"
    mathjax: null
---

```{r, include=FALSE}
# Check if document is being run as a child, if yes don't apply styling again
is_child <- !is.null(knitr::opts_knit$get("parent.frame"))
if (is_child) {
  knitr::opts_chunk$set(include = FALSE)
}
```

```{r, include=FALSE}

# Set up (add any additional libraries you may need)-----------------------------

library(RPostgres)
library(devtools)
library(stringr)
library(dplyr)
library(tidyr)
library(flextable)
library(ggplot2)


# Visualization tools (optional!)-------------------------

#add function that better fits the tables to the page

FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

# See "W:\Project\RJS\CTC\Github\JZ\cancel_the_contract\RDA Sense Making\sensemaking_jz.Rmd" for one ggplot and one flextable example
# if you want to visualize tables quickly

# See this script for examples of how to use the visual functions:
## W:\\Project\\RJS\CTC\\Github\\JZ\\cancel_the_contract\\Visuals\\visual_fx.R

# Guiding questions-------------------------

#1) What findings are you seeing that are interesting or surprising to you?
#2) What findings are you seeing that supplement OR contradict our narrative? 
#3) What additional questions do you have?
#4) What visualization ideas (chart types, figures to highlight, etc.) do you have? 

```

## JZ General notes

* Not sure if this makes sense for any of my analysis tables but potential visualization idea for other analyses (esp the more complex ones with multiple cuts like stops data by CFS or Not CFS): grouped waffle charts https://r-graph-gallery.com/407-geom-waffle-multiple-groups.html 

```{r}

#connect to postgres
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("cancel_the_contract")
con_shared <- connect_to_db("rda_shared_data")

# data dictionary
dict<-dbGetQuery(con, "SELECT * FROM data_dictionary")

```

## Antelope Valley general demographics

```{r}

# AV Demographic tables

av_race<-dbGetQuery(con, "SELECT * FROM av_population_race")
av_age<-dbGetQuery(con, "SELECT * FROM av_population_age")


```

### Antelope Valley population by race

* I think a straight bar graph of demographics by race will be nice to set the context for AV as a diverse place 

```{r}

title_text<-"The majority of residents in the AV are Latinx, White and Black"
subtitle_text<-"Population in Antelope Valley SPA 1"
caption_text<-paste0("Source: ",dict$source[dict$indicator_short=="Race"])

#graph

ggplot(av_race, aes(x = reorder(race, rate), y = rate))+
  geom_bar(stat = "identity", fill = "#362178") + #to create barplot
  geom_text(aes(label = paste0(round(rate,1), "%")), #add percentage labels within the bars
          vjust=.5, #center percentage within the bar
          hjust=0,
          size = 3,
          color = "black")+ 
  scale_x_discrete(labels = ~ str_wrap(as.character(.x), 5))+
  labs(title = title_text, 
       subtitle = subtitle_text,
       caption = caption_text,
       x = "", #labels to visual
       y = "") +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 0, hjust =0.5), #sets x-axis labels to be horizontal
      legend.position ="none", #removes legend
      plot.title = element_text(hjust=0.5),
      plot.subtitle = element_text(hjust=0.5),
       plot.caption = element_text(hjust = 0))+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size=12), #aesthetics of the barchart
        strip.background = element_rect(fill = "#362178"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
panel.background = element_blank())+
  coord_flip()


```

### Antelope Valley population by age

* The AV has a __large youth population__ that will be worth highlighting in the report. Not sure if it has to be visualized or just in the report text as context. 
* We could probably even get some more AV youth context for the report from the Region 5 State of the Child report if needed. 

```{r}

df<-av_age%>%
  mutate(rate=round(rate,1))%>%
  select(age_re, total, count, rate)

# ##Flextable for Age Group, Race##


  flextable(df) %>%
  set_caption('Antelope Valley SPA 1 Age Demographics') %>%
  theme_vanilla() %>%
  width(width=2,unit="in")
  
  
```

## AVUHSD general demographics

* Interesting to see that there are more Black students than White students. So if we have RIPA AVUHSD indicators with enrollment denominators something to consider and what arguments of disproportionately we can make. 
* Also given high Latinx/Black student enrollment need to be mindful of how we frame AVUHSD stops of these groups. 
* In general though I think it is important to be considerate of __race comparisons when we get to data of AVUHSD stops__. Regardless of race I think the point is that policing of youth in schools is bad.
* For visuals, maybe a table? Or it could even be a table with AVUHSD demographics AND AV SPA 1 demographics combined in a large table? Example from Pillars: https://github.com/catalystcalifornia/sdpillars/blob/main/report_embeds/report_calgangstats_table.Rmd 

```{r}

# AVUHSD Enrollment Data

enrollment <- dbGetQuery(con_shared, "SELECT * FROM education.cde_multigeo_enrollment_census_day_2024_25")

# get Antelope Valley Union High School District enrollment
av_enrollment <- enrollment %>% filter(districtname == "Antelope Valley Union High" & charter == "ALL")%>%
  filter(grepl("RE_", reportingcategory))

# recode racial categories

av_enrollment<-av_enrollment%>%
  mutate(reportingcategory_re=ifelse(reportingcategory %in% "RE_B", "nh_black",
                                     ifelse(reportingcategory %in% "RE_I", "nh_aian", 
                                            ifelse(reportingcategory %in% "RE_A", "nh_asian", 
                                                   ifelse(reportingcategory %in% "RE_F", "nh_filipino",  
                                                          ifelse(reportingcategory %in% "RE_H", "latinx", 
                                                                 ifelse(reportingcategory %in% "RE_D", "missing_race",
                                                                        ifelse(reportingcategory %in% "RE_P", "nh_nhpi",  
                                                                               ifelse(reportingcategory %in% "RE_T", "nh_twoormor",  
                                                                                      ifelse(reportingcategory %in% "RE_W", "nh_white", 
                                                                                             reportingcategory))))))))))%>%
  select(cdscode, districtname, reportingcategory_re, total_enr)

```

## AVUHSD Education indicators (graduation, suspensions, expulsions)

* Students with disabilities have a __lower graduation rate at 60.4%__ we should maybe use this with our __stop rates of students with disabilities__ emphasizing that these students should be having more time in classrooms and less time interacting with police. Noting students with disabilities was part of the original interest groups expressed by CTC. 
* Latinx (79.4%) and Black students (72.7%) have __lower graduation rates__ relative to other racial groups and they are the majority of the student population. 
* White students have a 5.1% suspension rate compared to 6.2% for Latinx students and 18.1% for Black students. Largest disparity for Black students. __Black students are being suspended at more than triple the rate of White students__ this supports our narrative about students of color losing time in the classroom. However we need to be intentional how we frame it so we aren't creating a narrative that "Black students are just bad kids" 
* Students with disabilities also have a high suspension rate at 13.7%. I think we should talk about this in the report especially as it relates to how are we serving our students who have different needs if we're kicking them out of classrooms. 
* Wondering if there is a way to visualize or state the suspension disparity as "time lost" in the classroom in a year. Or, something like "Out of 4 weeks of school, Black students lost X amount of time..." 
* Similar trend for expulsions although rates in a vacuum are not high. Black students have highest expulsion rate (0.5%) compared to White students (0.1%). 

```{r}

# School analysis tables
expulsions<-dbGetQuery(con, "SELECT * FROM analysis_expulsions")
grad<-dbGetQuery(con, "SELECT * FROM analysis_graduation")
suspension<-dbGetQuery(con, "SELECT * FROM analysis_suspensions")

```

## Stop results in AVUHSD

* Chauncee looked at an exported list of __'in field cite and release'__ result codes but wondering if we need to add another analysis table with actual codes and rates of the different codes. Maybe just of the top 10 codes? 
* I think a __Waffle chart__ in ggplot or something similar where we color what we consider 'non-serious' stop results similarly would work well here. Example from Pillars: https://github.com/catalystcalifornia/sdpillars/blob/main/report_embeds/report_timespent_ficard_gang_stop_item.Rmd 

```{r}


stops_result_avuhsd<-dbGetQuery(con, "SELECT * FROM analysis_stops_result_avuhsd") %>%
  mutate(rate=round(as.numeric(rate), 1))

  flextable(stops_result_avuhsd) %>%
  set_caption('Results of Stops in AVUHSD Schools') %>%
  theme_vanilla() %>%
  width(width=2,unit="in")
  


```