
```{r}
library(dplyr)
library(RPostgreSQL)
library(sf)
library(tidyr)
library(tidyverse)
library(srvyr)
library(survey)
library(knitr)
library(kableExtra)
library(weights)
library(sysfonts)
library(extrafont)
library(showtext)
options(scipen=999)

# connect to postgres and pull credentials
source("W:\\RDA Team\\R\\credentials_source.R")
con_bv <- connect_to_db("bold_vision")
con_ctc <- connect_to_db("cancel_the_contract")

#raw survey data 
raw_svy_data <- dbGetQuery(con_bv, "SELECT * FROM youth_thriving.raw_survey_data")
#data dictionary
svy_dd <- dbGetQuery(con_bv, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 where response_type = 'mc' AND response_domain !='Demographics' AND response_domain != 'Info'")

# rename relevant column to foster_care, indicating respondents who are foster youth
svy_data <- raw_svy_data %>% 
  rename(foster_care = ga)
```


```{r}
# This function returns a response frequency table for all questions in the Bold Vision Youth Thriving survey, for a specified demographic group. This function is from W:/Project/OSI/Bold Vision/Youth Thriving Survey/GitHub/MK/boldvision_youththriving/Descriptive and Demographic Analyses/analysis_freq_by_demo.R, which has already been QAed.
fx_freq_table  <- function(demographic_variable) {
  weights_col <- "weights_final"  # Define the weight column name
  unique_indicators <- unique(svy_dd$variable)  # Extract unique indicators
  
  combined_data_list <- list()
  
  for (i in unique_indicators) { 
    # Filter and pivot dictionary
    dict <- svy_dd %>%
      filter(variable == i) %>%
      pivot_longer(cols = response_1:response_12,
                   names_to = "response_numbers",
                   values_to = "response",
                   values_drop_na = TRUE)
    
    dict_var <- dict %>%
      mutate(variable_merge_col = 1:nrow(dict))
    
    # Filter survey data, remove NAs, and summarize
    df_var <- as_survey(svy_data, weights = !!sym(weights_col)) %>%
      filter(!is.na(!!sym(i)), !is.na(!!sym(demographic_variable))) %>%  # Remove NAs
      group_by(!!sym(demographic_variable), !!sym(i)) %>%
      summarise(count = n(), 
                rate = survey_mean(vartype = c("cv", "se"), level = .90), .groups = "drop") %>%
      mutate(rate = rate * 100, 
             rate_cv = rate_cv * 100, 
             moe = rate_se * 1.645 * 100) %>%
      mutate(!!sym(demographic_variable) := case_when(
        !!sym(demographic_variable) == 1 ~ demographic_variable, 
        !!sym(demographic_variable) == 0 ~ paste0("not ", demographic_variable),
        TRUE ~ as.character(!!sym(demographic_variable)) # Keep other values unchanged
      ))
    
    # Merge data with dictionary
    df_almost_final <- merge(x = df_var, y = dict_var, 
                             by.x = i, by.y = "variable_merge_col") %>%
      relocate(response) 
    
    df_final_per_demo <- df_almost_final %>%
      relocate(!!sym(demographic_variable)) %>%
      select(all_of(demographic_variable), response, count, rate, rate_cv, moe, 
             variable, question, sub_question, question_number, likert_type,
             variable_name, response_domain)
    
    combined_data_list[[i]] <- df_final_per_demo
  }

  # Combine all dataframes into one
  df_merged <- do.call(rbind, combined_data_list)
  
  # Dynamically name the output dataframe
  table_name <- paste0("df_merged_per_", demographic_variable)
  assign(table_name, df_merged, envir = .GlobalEnv)  # Store in global environment
  
  return(df_merged)
}
```

```{r}
# Grab tables from the bold_vision database to see the response breakdown for all youth, as well as youth who have been arrested, suspended, and/or unhoused. We are interested in responses to the mental health question, "Q9. About how often during the past 30 days did you feel worthless?"

response_analysis_per_total <- dbGetQuery(con_bv, "SELECT * FROM youth_thriving.tot_freq_strong_minds WHERE variable = 'cy'") %>% 
  mutate(group= "all youth") %>%
  rename(count = frequency, rate = weighted_percent) %>%
  select(group, response, count, rate, question, sub_question)
response_analysis_per_suspended <- dbGetQuery(con_bv, "SELECT * FROM youth_thriving.response_analysis_per_suspended WHERE variable = 'cy' AND suspended = 'suspended'") %>% rename(group = suspended)
response_analysis_per_arrested <- dbGetQuery(con_bv, "SELECT * FROM youth_thriving.response_analysis_per_arrested WHERE variable = 'cy' AND arrested = 'arrested'") %>% rename(group = arrested)
response_analysis_per_unhoused <- dbGetQuery(con_bv, "SELECT * FROM youth_thriving.response_analysis_per_unhoused WHERE variable = 'cy' AND unhoused = 'unhoused'") %>% rename(group = unhoused)

# Get response breakdown for foster youth
response_analysis_per_foster <- fx_freq_table("foster_care") %>% 
  filter(variable == "cy") %>%
  rename(group = foster_care) %>%
  select(-c(likert_type, ))

# Combine all the group data into one dataframe
demo_df <- rbind(response_analysis_per_arrested, response_analysis_per_foster, response_analysis_per_suspended, response_analysis_per_unhoused) %>%
  select(group, response, count, rate, question, sub_question) %>%
  rbind(response_analysis_per_total) %>%
  arrange(response)
```

```{r}
# Write table with metadata
table_name <- "analysis_mentalhealth_lacounty"
schema <- "data"
indicator <- "A table of response rates to the Bold Vision Youth Thriving survey question <About how often during the past 30 days did you feel worthless?> for all youth, as well as youth who have been in foster care, arrested, suspended, and/or unhoused."
source <- "Script: W:/Project/RJS/CTC/Github/AV/cancel_the_contract/Analysis/analysis_mental_health.Rmd"
qa_filepath <- "See QA doc for details: W:/Project/RJS/CTC/Documentation/QA_analysis_mental_health.docx"
table_comment <- paste0(indicator, source)
# dbWriteTable(con_ctc, Id(schema, table_name), demo_df, overwrite = TRUE, row.names = FALSE)

# Comment on table and columns
column_names <- colnames(demo_df) # Get column names
column_comments <- c(
  "The group type, either all youth or a specific demographic",
  "The response to the question, ranging from feeling worthless none of the time to all of the time",
  "The number of youth in the specified group who chose the specified response",
  "The rate of youth in the specified group who chose the specified response",
  "The question wording",
  "The rest of the question wording"
)

# add_table_comments(con_ctc, schema, table_name, indicator, source, qa_filepath, column_names, column_comments)
```

```{r}
dbDisconnect(con_bv)
dbDisconnect(con_ctc)
```

