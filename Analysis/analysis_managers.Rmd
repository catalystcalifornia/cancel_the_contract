---
title: "Employment as managers rates by race"
author: "Alicia Vo"
date: "2025-07-10"
output: html_document
---
# Load packages, connect to postgres, get spatial data
```{r}
# Install packages if not already installed
packages <- c("data.table", "readxl", "stringr", "dplyr", "RPostgres", "dbplyr", "srvyr", "tidycensus", "rpostgis",  "tidyr", "here", "sf", "usethis") 

install_packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(install_packages) > 0) {
  install.packages(install_packages)
} else {
  print("All required packages are already installed.")
}

for(pkg in packages){
  library(pkg, character.only = TRUE)
}

options(scipen = 100) # disable scientific notation

# Connect to postgres 
source("W:\\RDA Team\\R\\credentials_source.R")
con_shared<-connect_to_db("rda_shared_data")

# Grab SPA-tract xwalk so that we can get all tracts within SPA 1 which we are using as our AV geography. Census tracts are 2023.
spa <- dbGetQuery(con_shared, "SELECT * FROM crosswalks.lacounty_health_district_spa_tract_2022")%>%
  filter(spa_num==1)

# Pull out the tracts for spa 1
ct_av <- spa$ct_geoid

# Get crosswalk of tracts to PUMAs (uses 2020 PUMA data and 2020 tract data for CA)
xwalk <- dbGetQuery(con_shared, "SELECT *FROM crosswalks.puma_tract_xwalk_2020")

# Filter crosswalk for AV tracts only
xwalk_puma_ct <- xwalk %>% 
  filter(ct_geoid %in% ct_av)

# Create list of PUMA ids in AV (only 3 PUMAs in AV)
puma_av <- unique(xwalk_puma_ct$puma_geoid)
puma_av <- paste0("06",puma_av)

# define variables used throughout - update each year
curr_yr <- 2023 
start_yr <- curr_yr - 4  # autogenerate start yr of 5yr estimates

### define common inputs for calc_pums{} and pums_screen{}
indicator = 'officials'         # name of column that contains indicator data, eg: 'living_wage' which contains values 'livable' and 'not livable'
indicator_val = 'officials'     # desired indicator value, eg: 'livable' (not 'not livable')        
weight = 'PWGTP'                # PWGTP for person-level (psam_p06.csv) or WGTP for housing unit-level (psam_h06.csv) analysis
```

# Get PUMS Data -----------------------------------------------------------
```{r}
# Data Dictionary: https://www2.census.gov/programs-surveys/acs/tech_docs/pums/data_dict/PUMS_Data_Dictionary_2023.pdf
# path where my data lives (not pulling pums data from the postgres db, takes too long to run calcs that way) 
root <- paste0("W:/Data/Demographics/PUMS/CA_", start_yr, "_", curr_yr, "/")
# Load ONLY the PUMS columns needed for this indicator
cols <- colnames(fread(paste0(root, "psam_p06.csv"), nrows=0)) # get all PUMS cols 
cols_wts <- grep("^PWGTP*", cols, value = TRUE)                # filter for PUMS weight colnames

ppl <- fread(paste0(root, "psam_p06.csv"), header = TRUE, data.table = FALSE, 
             select = c(cols_wts, "AGEP", "ESR", "SCH", "SOCP", "PUMA", "ANC1P", "ANC2P", "HISP", "RAC1P","RACAIAN", "RACPI", "RACNH"),
             colClasses = list(character = c("ESR", "SCH", "SOCP", "PUMA", "ANC1P", "ANC2P", "HISP", "RAC1P", "RACAIAN", "RACPI", "RACNH")))

# Add state_geoid to ppl, add state_geoid to PUMA id, so it aligns with crosswalks.puma_county_2020
ppl$state_geoid <- "06"
ppl$puma_id <- paste0(ppl$state_geoid, ppl$PUMA)


# create list of replicate weights
repwlist = rep(paste0("PWGTP", 1:80))

# save copy of original data
orig_data <- ppl

# redo analysis
ppl <- orig_data

# Filter for AV PUMAS ----------------------------------------------------
ppl <- ppl %>%
  filter(puma_id %in% puma_av)
```

##### Reclassify Race/Ethnicity ########
```{r}
source("W:/RDA Team/R/Github/RDA Functions/main/RDA-Functions/PUMS_Functions_new.R")    

# latino includes all races. AIAN is AIAN alone/combo latino/non-latino, NHPI is alone/combo latino/non-latino, SWANA includes all races and latino/non-latino
ppl <- race_reclass(ppl, start_yr, curr_yr)

table(ppl$race)
table(ppl$aian)
table(ppl$latino)
table(ppl$swana)
table(ppl$pacisl)

# create columns nh_aian, nh_nhpi
ppl_nh <- ppl %>%
  mutate(nh_aian = ifelse(aian=="aian" & latino=="not latino", "nh_aian", "not nh_aian"),
         nh_nhpi = ifelse(pacisl=="pacisl" & latino=="not latino", "nh_nhpi", "not nh_nhpi"))

```

##### Classify SSWANA ########
```{r}
# I need columns nh_asian_wo_sa and sswana, which I can make once I create a south_asian column. 

# reference from av_race_pop.R
soasian_list<-list("Asian Indian", "Bangladeshi", "Bhutanese","Maldivian","Nepalese","Pakistani","Sikh","Sindhi","Sri Lankan","Other South Asian")

# read in PUMS data dictionary at the row where ANC1P starts and filter for south asian ancestries
pums_dict <- read.csv("W:/Project/RJS/CTC/Data/PUMS_Data_Dictionary_2019-2023.csv", skip=1808)%>%
  rename(ancestry = Austrian, code = X003) %>%
  select(ancestry, code) %>% 
  filter(ancestry %in% soasian_list)

# create south asian column
ppl_soasian <- ppl_nh %>%
  mutate(soasian = ifelse(ANC1P %in% pums_dict$code | ANC2P %in% pums_dict$code, "south asian", "not south asian"))

# qa check
qa <- ppl_soasian %>%
  select(ANC1P, ANC2P, soasian) %>%
  filter(soasian == "south asian") %>%
  left_join(pums_dict, by = c("ANC1P"="code")) %>%
  left_join(pums_dict, by = c("ANC2P"="code"))
table(qa$ancestry.x)
table(qa$ancestry.y)

# create columns nh_asian_wo_sa and sswana
ppl_sswana <- ppl_soasian %>%
  mutate(nh_asian_wo_sa = ifelse(race=="nh_asian" & soasian=="not south asian", "nh_asian_wo_sa", "not nh_asian_wo_sa"),
        sswana = ifelse(swana=="swana" & soasian=="south asian", "sswana", "not sswana"))

ppl <- ppl_sswana
```



##### Define Officials and Managers ###########
```{r}
# For this project we only wanted data for people in labor market - ages between 18 and 64
ppl <- ppl[ppl$AGEP >= 18 & ppl$AGEP <= 64 , ]

## Tag people who are officials or managers: SOCP value starts with "11" 
###### See p110 in W:\Data\Demographics\PUMS\CA_2019_2023\PUMS_Data_Dictionary_2023.pdf
ppl$offmgr <- 
  case_when(
    grepl('^11', ppl$SOCP) ~ as.integer(1),
    TRUE ~ as.integer(0))

# review
summary(ppl$offmgr)
sum(ppl$offmgr)


## Code for labor force status: ESR on p56 of PUMS_Data_Dictionary_2023.pdf https://www2.census.gov/programs-surveys/acs/tech_docs/pums/data_dict/PUMS_Data_Dictionary_2023.pdf
table(ppl$ESR, useNA = "always")

# NOTE: 'This includes 4-Armed forces, at work' and '5-Armed forces, with a job but not at work'. It excludes '6-Not in labor force'.
ppl$emply <- as.factor(ifelse(ppl$ESR %in% c(1, 2, 3, 4, 5), "in labor force", "not in labor force")) 
ppl <- filter(ppl, emply=='in labor force')

## Factor for Officials & Managers
ppl$officials <- ifelse(ppl$offmgr == 1, "officials", "not official")
ppl$officials <- as.factor(ppl$officials)
ppl$indicator <- as.factor(ppl$officials)

## check race and officials results
table(ppl$nh_race, useNA ="always")
table(ppl$indicator, useNA = "always")
```


############### CALC PUMA ESTIMATES/CVS ETC. ############### 
```{r}
ppl_calc <- ppl %>% mutate(geoid = "", geoname = "Antelope Valley")

managers <- calc_pums(d = ppl_calc, indicator, indicator_val, weight)
```



