---
title: "Employment as managers rates by race"
author: "Alicia Vo"
date: "2025-07-10"
output: html_document
---

```{r}
library(data.table)

# Connect to postgres 
source("W:\\RDA Team\\R\\credentials_source.R")
con_shared<-connect_to_db("rda_shared_data")
```

```{r}
# Grab SPA-tract xwalk so that we can get all tracts within SPA 1 which we are using as our AV geography. Census tracts are 2023.
spa <- dbGetQuery(con_shared, "SELECT * FROM crosswalks.lacounty_health_district_spa_tract_2022")%>%
  filter(spa_num==1)

# Pull out the tracts for spa 1
ct_av <- spa$ct_geoid

# Get puma to census tract crosswalk
xwalk <- dbGetQuery(con_shared, "SELECT *FROM crosswalks.puma_tract_xwalk_2020")

# Filter crosswalk for AV tracts only
xwalk_puma_ct <- xwalk %>% 
  filter(ct_geoid %in% ct_av)

# Create list of PUMA ids in AV (only 3 PUMAs in AV)
puma_av <- unique(xwalk_puma_ct$puma_geoid)
```

# Get PUMS Data -----------------------------------------------------------
```{r}
# Data Dictionary: https://www2.census.gov/programs-surveys/acs/tech_docs/pums/data_dict/PUMS_Data_Dictionary_2023.pdf
# path where my data lives (not pulling pums data from the postgres db, takes too long to run calcs that way) 
root <- paste0("W:/Data/Demographics/PUMS/CA_2019_2023/")

# Load ONLY the PUMS columns needed for this indicator
cols <- colnames(fread(paste0(root, "psam_p06.csv"), nrows=0)) # get all PUMS cols 
cols_ <- grep("^PWGTP*", cols, value = TRUE)     # filter for PUMS weight colnames
ppl <- fread(paste0(root, "psam_p06.csv"), header = TRUE, data.table = FALSE, select = c(cols_, "AGEP", "ESR", "SCH", "SOCP", "PUMA", "ANC1P", "ANC2P", "HISP", "RAC1P", "RAC2P", "RAC3P", "RACAIAN", "RACPI", "RACNH"),
             colClasses = list(character = c("ESR", "SCH", "SOCP", "PUMA", "ANC1P", "ANC2P", "HISP", "RAC1P", "RAC2P", "RAC3P", "RACAIAN", "RACPI", "RACNH")))

# Add state_geoid to ppl, add state_geoid to PUMA id
ppl$state_geoid <- "06"
ppl$puma_id <- paste0(ppl$state_geoid, ppl$PUMA)

# Create list of replicate weights
repwlist = rep(paste0("PWGTP", 1:80))

# Save copy of original data
orig_data <- ppl
```

```{r}
# Filter PUMA data for only PUMAs in AV
ppl <- ppl[ppl$PUMA %in% puma_av, ]
```

