```{r}
source("./visual_fx.R")

con_ctc<- connect_to_db("cancel_the_contract")

pop_race<-dbGetQuery(con_ctc, "SELECT * FROM avuhsd_population_race")

stops_race<-dbGetQuery(con_ctc, "SELECT * FROM analysis_stops_race")

dbDisconnect(con_ctc)

all_stops <- stops_race %>%
  filter(universe=="All stops") %>%
  rename("label"="reportingcategory_re") %>%
  race_recode(.) 

df<- all_stops %>%
  inner_join(pop_race, by = c("label"="race"))

indicator.y <- "Student Population"
indicator.x <- "Police Stops by Race AVUHSD"

myindicator.y <- "Student Population"
myindicator.x <- "Police Stops"
title_text <- "AVUHSD officers stop Black students at nearly 2x the rate of their population"

race_note <- "Race Note: AIAN=American Indian/Alaskan Native Alone, NHPI=Native Hawaiian/Pacific Islander. All racial groups are exclusive of Latinx except for AIAN, Latinx, and NHPI which are alone or in combination with other racial groups."
```

```{r}
double_bar <- function(df, indicator.x, indicator.y, myindicator.x, myindicator.y, title_text, race_note) {
  
  # Rename rate columns explicitly if needed
  if(!("rate.x" %in% names(df)) | !("rate.y" %in% names(df))) {
    stop("Your dataframe must include columns named rate.x and rate.y")
  }
  
  # Reshape the data into long format
  df_long <- df %>%
    pivot_longer(cols = c(rate.x, rate.y),
                 names_to = "group",
                 values_to = "rate") %>%
    mutate(group = recode(group,
                          "rate.x" = myindicator.x,
                          "rate.y" = myindicator.y)) %>%
  mutate(group = factor(group, levels = c(myindicator.y, myindicator.x)))
  
  # Define max y
  max_y <- 1.15 * max(df_long$rate, na.rm = TRUE)
  
  # Subtitle text
  subtitle_text <- paste0(myindicator.x,
                          " compared to ",
                          myindicator.y)
  
  # Caption text
  caption_text <- paste0(
    "Source: Catalyst California calculations of ",
    dict$source[dict$indicator_short == indicator.x], " ",
    dict$year[dict$indicator_short == indicator.x],
    " and ",
    dict$source[dict$indicator_short == indicator.y], " ",
    dict$year[dict$indicator_short == indicator.y],
    " data. ",
    race_note
  )
  caption_text <- str_wrap(caption_text, width = 110)
  
  # Graph
  final_visual <- ggplot(df_long, aes(x = reorder(label, rate), y = rate, fill = group)) +
    geom_col(position = position_dodge(width = 0.7), width = 0.6) +
    
    # Bar labels
    geom_text(aes(label = paste0(round(rate, 1), "%")),
              position = position_dodge(width = 0.7),
              hjust = -0.1,
              vjust = 0.5,
              colour = "black",
              family = font_bar_label) +
    scale_fill_manual(values = c(teal, textgrey),
                      breaks = c(myindicator.x, myindicator.y)) +
    labs(title = str_wrap(title_text, width = 65),
         subtitle = str_wrap(subtitle_text, width = 80),
         caption = caption_text,
         fill = "") +
    
    scale_x_discrete(labels = function(label) str_wrap(label, width = 20)) +
    xlab("") +
    ylab("") +
    expand_limits(y = c(0, 100)) +
    coord_flip() +
    theme_minimal() +
    theme(
      legend.position = "top",
      legend.text = element_text(size = 10, family = font_axis_label),
      axis.text.y = element_text(size = 10,
                                 margin = margin(0, -10, 0, 0),
                                 colour = black,
                                 family = font_axis_label),
      axis.text.x = element_blank(),
      plot.caption = element_text(hjust = 0.0, size = 8, colour = black, family = font_caption),
      plot.title = element_text(hjust = 0.0, size = 21, colour = black, family = font_title),
      plot.subtitle = element_text(hjust = 0.0, size = 14, colour = black, family = font_subtitle),
      axis.ticks = element_blank(),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(size = 0.25),
      panel.grid.major.y = element_blank()
    )
  
  # Define base file path
  base_path <- paste0("./Visuals/", myindicator.x, "_vs_", myindicator.y, "_doublebar")
  
  showtext_opts(dpi = 300)
  
  # Save outputs
  ggsave(plot = final_visual, filename = paste0(base_path, ".svg"),
         device = "svg", width = 9, height = 6.5)
  
  ggsave(plot = final_visual, filename = paste0(base_path, ".png"),
         device = "png", width = 9, height = 6.5)
  
  return(final_visual)
}

double_bar(df, indicator.x, indicator.y, myindicator.x, myindicator.y, title_text, race_note)

```
