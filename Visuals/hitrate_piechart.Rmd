```{r}
source("./visual_fx.R")

con_ctc<- connect_to_db("cancel_the_contract")

df<-dbGetQuery(con_ctc, "SELECT contraband_evidence_discovered_none as label, rate FROM analysis_stops_hitrate_avuhsd")

df_subset <- df %>%
  mutate(label = ifelse(label=="0", "Contraband", "No contraband"))

indicator <- "Police Hit Rate AVUHSD"
title_text <- "The vast majority of LASD searches of AVUHSD students result in no contraband"
```

```{r}
pie_chart <- function(df, indicator, title_text) {

  width <- 3.5   # inches
  height <- 3.5  # inches  

  # Adjust width based on title length
  title_length <- nchar(title_text)
  title_text <- str_wrap(title_text, width = width * 17.5)

  subtitle_text <- ""
  
  caption_text<-paste0("Source: Catalyst California calculations of ",dict$source[dict$indicator_short==indicator]," data, ", dict$year[dict$indicator_short==indicator],". ",dict$race_note[dict$indicator_short==indicator]) 

  caption_text <- str_wrap(caption_text, width = width * 20)

  grey_label_name <- df$label[which.min(df$rate)]
  
  # ---- build plot ----
  final_visual <- ggplot(df, aes(x = "", y = rate, fill = label)) +
    geom_col(color = "white", width = 0.2, show.legend = TRUE) +
    coord_polar(theta = "y") +
    # center labels inside slices
    # geom_text(aes(label = paste0(round(rate, 1), "%")),
    #           position = position_stack(vjust = 0.5),
    #           family = font_bar_label,
    #           size = 6,
    #           colour = black) +
    geom_text(
      aes(
        label = paste0(round(rate, 1), "%"),
        colour = ifelse(label == grey_label_name, black, "white"),
        family = ifelse(label == grey_label_name, "gillsans", "gillsans_bold")
      ),
      position = position_stack(vjust = 0.5),
      # family = font_bar_label,
      size = 6,
      show.legend = FALSE
    ) +

    scale_fill_manual(values = c(textgrey, teal), guide = guide_legend(reverse = FALSE)) +
    scale_colour_identity() +
    labs(title = title_text, subtitle = subtitle_text, caption = caption_text, fill = "") +
    theme_minimal() +
    theme(
      axis.text = element_blank(),
      axis.title = element_blank(),
      panel.grid = element_blank(),
      axis.ticks = element_blank(),

      plot.title = element_text(hjust = 0, size = 18, family = font_title, colour = black),
      plot.subtitle = element_text(hjust = 0, size = 16, family = font_subtitle, colour = black),
      plot.caption = element_text(hjust = 0, size = 12, family = font_caption, colour = black),
      plot.background = element_rect(fill = "white", color = NA),

      legend.text = element_text(size = 12, family = font_axis_label, colour = black),
      legend.position = "right"
    )

  # ---- export ----
  export_dir <- here::here("Visuals", "Exports")
  dir.create(export_dir, recursive = TRUE, showWarnings = FALSE)
  outfile <- file.path(export_dir, paste0(indicator, "_pie.png"))

  ragg::agg_png(outfile, width = width, height = height, units = "in", res = 150)
  print(final_visual)
  dev.off()

  return(final_visual)
}

pie_chart(df_subset, indicator, title_text) 
```